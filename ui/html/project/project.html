<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#FFFFFF">
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
  <title>REDTEAM | 프로젝트 관리</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Roboto">
  <link rel="stylesheet" href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome.min.css">
  <link rel="stylesheet" href="/css/sport.min.css" type="text/css">
  <link rel="stylesheet" href="/css/choices.min.css" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap-grid.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
</head>
<body>
<!--네이게이터-->
<div class="sidebar">
  <div class="sidebar-header"><a href="#">
    <img src="/image/intro_icon.png" style="max-width: 80%; height: auto;">
  </a>
    <div class="sidebar-control"><i class="la la-navicon"></i></div>
  </div>
  <div class="sidebar-wrapper">
    <ul class="list-menu">
      <li class="header">Total Info</li>

      <li class="tree-item"><a href="/dashboard/total"><i class="la la-group"></i><span>대시보드</span>
        <div class="right-container"></div>
      </a>

      <li class="header">Project Info</li>
      <li class="tree-item active"><a href="/project/progress"><i class="la la-group"></i><span>프로젝트 관리</span>
        <div class="right-container"></div>
      </a>

<!--      <li class="tree-item active"><a href="/project/example"><i class="la la-group"></i><span>테스트</span>-->
<!--        <div class="right-container"></div>-->
<!--      </a>-->

      </li>
      <li class="tree-item"><a href="/manager/target"><i class="la la-group"></i><span>대상관리</span>
        <div class="right-container"></div>
      </a>

      </li>
      <li class="tree-item"><a href="/manager/template"><i class="la la-file-text"></i><span>템플릿관리</span>
        <div class="right-container"></div>
      </a>
      </li>
      <li class="tree-item"><a href="/project/create"><i class="la la-pencil-square"></i><span>프로젝트 생성</span>
        <div class="right-container"></div>
      </a>
      </li>
      <li class="header">Setting</li>
      <li class="has-children"><a href="javascript:;"><i class="la la-cog"></i><span>설정</span>
        <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
      </a>
        <ul class="tree">
          <li class="tree-item"><a href="/setting/user"><i
                  class="la la-circle"></i><span style="font-size:0.8em;">사용자 정보</span></a></li>
          <li class="tree-item"><a href="/setting/smtp"><i
                  class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
        </ul>
      </li>
    </ul>
  </div>
</div>
<!--네이게이터-->


  <div class="main-content">
    <div class="header">
      <div class="left">
        <p></p>
        <div class="breadcrumb"><span>프로젝트 관리</span></div>
      </div>
      <ul class="right">
        <li class="header-user dropdown ml-4 mr-3"><a class="user-photo trigger-dropdown"><img class="user-img"
                                                                                               src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/101e1fb9-0b2e-4f2d-acfb-a777dc48f629/d4sn4w7-2a5d1fdf-2af2-408a-9300-08f28cd12951.png"/></a>
          <div class="dropdown-box with-header">
            <div class="dropdown-header"><img class="user-img user-img--lg"
                                              src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/101e1fb9-0b2e-4f2d-acfb-a777dc48f629/d4sn4w7-2a5d1fdf-2af2-408a-9300-08f28cd12951.png"/>
              <div class="user-info">
                <h3 id="dropdown_name">name</h3><span class="helper-text" id="dropdown_id">email</span>
              </div>
            </div>
            <ul class="dropdown-body">
              <li><a href="/setting/user" target="_blank"><i
                      class="la la-user"></i><span>사용자 정보</span></a></li>
              <li><a  href="/setting/smtp"><i class="la la-cogs"></i><span>SMTP 설정</span></a></li>
              <li><a href="javascript:Logout();"><i class="la la-power-off"></i><span>로그아웃</span></a></li>
            </ul>
          </div>
        </li>
      </ul>
      <div class="right--mobile"><a class="header-item--mobile sidebar-control"><i class="la la-navicon"></i></a><a class="header-item--mobile"><i class="la la-comments"></i></a><a class="header-item--mobile"><i class="la la-ellipsis-v"></i></a></div>
    </div>

    <div class="content-wrapper">
      <div class="row">
        <div class="col-12">
          <div class="box">
            <div class="box-header">
              <h3>프로젝트 관리</h3>
            </div>

<!--            템플릿 뷰어     -->
            <div class="pgn-modal" id="my_modal">
              <div class="pgn-modal-wrapper ">
                <!--   <div class="modal__header">
                      <h5>템플릿 수정</h5>
                      <div class="toolbox">
                        <button class="btn-modal-close modal-dismiss" onclick="closeModal()"><i
                                class="la la-times"></i></button>
                      </div>
                    </div>
                    <div class="modal__body">
                      <div class="form-group w-50">
                        <label for="tmp_division">구분</label><select id="tmp_division">
                        <option value="1" selected>기본</option>
                        <option value="2">사용자</option>
                      </select>
                      </div>

                      <div class="form-group w-50">
                        <label for="tmp_kind">훈련유형</label><select id="tmp_kind">
                        <option value="1" selected>경고 안내</option>
                        <option value="2">피싱 유도</option>
                        <option value="3">실태 조사</option>
                      </select>
                      </div>

                      <div class="form-group w-50">
                        <label for="file_info">첨부파일 정보</label><select id="file_info">
                        <option selected value="">첨부파일 없음</option>
                        <option value="1">EXE</option>
                        <option value="2">HTML</option>
                        <option value="3">Excel</option>
                      </select>
                      </div>

                      <div class="form-group">
                        <label for="tmp_name">템플릿명</label>
                        <input type="text"
                               id="tmp_name"
                               maxlength="30">
                        <input type="hidden" id="tmp_no">
                      </div>

                      <div class="form-group">
                        <label for="sender_name">발송자명</label>
                        <input type="text"
                               id="sender_name"
                               maxlength="30">
                      </div>
                      <label>발송자</label>

                  <div class="form-group">
                    <label for="title">메일 제목</label>
                    <input type="text"
                           id="title" maxlength="60"></div>
                   <label>메일 제목(최대 30자)</label>


                  <textarea name="content" id="content"></textarea>
                 <script>
                    CKEDITOR.replace('content');
                  </script> -->
                  <div class="form-group">
                    <div style="color: red;font-weight: bold; font-size: small">
                      {{target_name}} : 훈련 대상자의 이름, {{count_ip}} : 악성메일 훈련 솔루션 IP, {{target_position}}
                      : 직급, {{targer_orgarnize}} : 조직, {{targer_phone}} : 훈련 대상자의 전화번호
                    </div>
                  </div>
                  <div class="form-group w-50">
                    <label for="download_type">다운로드 방식</label><select id="download_type">
                    <option selected value="">첨부파일 없음</option>
                    <option value="1">링크 첨부</option>
                  </select> -->
                  </div>

                </div>
                <div class="modal__footer">
                  <button class="btn btn-ghost modal-dismiss" onclick="closeModal()">취소</button>
                  <button class="btn btn-primary modal-dismiss" onclick="delTml()">삭제</button>
                  <button class="btn btn-primary pull-right" id="tag_reg" onclick="editTml()">수정하기
                  </button>
                </div>
              </div>
            </div>

            <div class="toolbox">
              <div class="box-body pt-0 px-0 responsive">
                <table id="project_list">
                  <thead>
                  <tr>
                    <th style="visibility:hidden;position:absolute;"></th>
                    <th>No</th>
                    <th>프로젝트명</th>
                    <th>대상 태그</th>
                    <th>진행상태</th>
                    <th>템플릿명</th>
                    <th>대상자 수</th>
                    <th>감염 현황(%)</th>
                    <th>프로젝트 종료</th>
                    <th>시작일</th>
                    <th>종료일</th>
                  </tr>
                  </thead>
                  <tbody>
                </table>
              </div>
            </div>


            <div class="pagination-wrapper clearfix" id="under">
              <ul class="pagination float--right" id="pages">
              </ul>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
<script src="/js/lib/Sortable.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/jquery.serialize-object.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/demo.js"></script>
<script src="/js/script.js"></script>
<script>
  function getTag() {
    console.log('getTagForTargetInfo')
    const r = new XMLHttpRequest();
    r.open('GET', 'http://localhost:5000/setting/getTag', true);
    r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    r.withCredentials = true;
    r.onreadystatechange = function () {
      //let rObj;
      if (r.readyState === 4) {
        if (r.status === 200) {
          rObj = JSON.parse(r.responseText);
          if (rObj.tags.length > 0) {
            $('#tag_menage > tbody').empty();
            for (let j = 0; j < rObj.tags.length; j++) {
              $('#tag_menage >tbody:last').append("<tr id='tag_" + rObj.tags[j].tag_no + "'>" +
                      "                        <td>" + rObj.tags[j].tag_name + "</td>\n" +
                      "                        <td>" + rObj.tags[j].created_t + "</td>\n" +
                      "                        </tr>");
            }
          }
        } else if (r.status === 403) {
          const tokenResult = Refresh()
          if (tokenResult) {
            getTag();
            console.log("true")
          }
        } else {
          document.location.href = '/';
        }
      }
    };
    r.send();
  }

  function GetProject() {
    const r = new XMLHttpRequest();
    r.open('GET', 'http://localhost:5000/api/getProject', true);
    r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    r.withCredentials = true;
    r.onreadystatechange = function () {
      let rObj;
      if (r.readyState === 4) {
        if (r.status === 200) {
          rObj = JSON.parse(r.responseText);
          //console.log(r.responseText);

          if (rObj.project_list != null) {
            // table 비워주기
            $('#project_list > tbody').empty();
            // No, 프로젝트명, 대상 태그, 진행상태, 템플릿명, 대상자 수, 감염 현황(%), 프로젝트 종료, 시작일, 종료일
            // No, p_name, tag_name, p_status, p_name, targets, infection, end_date, start_date
            for (let i = 0; i < rObj.project_list.length; i++) {
              // 태그 분리작업
              let full_tag = ''
              let status = ''
              let end = ''
              let infection_percentage
                for (let j = 0; j < rObj.project_list[i].tag_no.length; j++) {
                  // console.log(rObj.project_list
                  if (rObj.project_list[i].tag_no[j] !== "") {
                    if (j === 0) {
                      full_tag += '<label class="badge badge-green">' + rObj.project_list[i].tag_no[j] + '</label>'
                    } else if (j === 1) {
                      full_tag += '<label class="badge badge-red">' + rObj.project_list[i].tag_no[j] + '</label>'
                    } else if (j === 2) {
                      full_tag += '<label class="badge badge-blue">' + rObj.project_list[i].tag_no[j] + '</label>'
                    }
                  }
                }
                // 프로젝트 진행 상황에 따라 버튼들의 색들을 다 다르게한다.
                if (rObj.project_list[i].p_status === "0") {
                  rObj.project_list[i].p_status = "예약";
                  let test11 = "해당 프로젝트를 실행하시겠습니까?";
                  status += '<button class="btn" style="color: white; padding: 4px 7px; background: #FFD764;' +
                          ' border: 2px solid transparent; border-radius: 3px;" ' +
                          'onclick="ProjectStart(' + rObj.project_list[i].p_no + ')">'
                          + rObj.project_list[i].p_status + '</button>'
                  end += '<button class="btn btn-c-success" id="project_end" ' +
                          'onclick="ProjectEnd(' + rObj.project_list[i].p_no + ')">프로젝트 종료하기</button>'
                } else if (rObj.project_list[i].p_status == "1") {
                  rObj.project_list[i].p_status = "진행";
                  status += '<button class="btn" style="color: white; padding: 4px 7px; background: #00A6A0;' +
                          ' border: 2px solid transparent; border-radius: 3px;">'
                          + rObj.project_list[i].p_status + '</button>'
                  end += '<button class="btn btn-c-success" id="project_end" ' +
                          'onclick="ProjectEnd(' + rObj.project_list[i].p_no + ')">프로젝트 종료하기</button>'
                } else if (rObj.project_list[i].p_status == "2") {
                  rObj.project_list[i].p_status = "종료";
                  status += '<button class="btn btn-primary">' + rObj.project_list[i].p_status + '</button>'
                  end += '<button class="btn btn-disabled" id="project_end" disabled="disabled" ' +
                          'onclick="ProjectEnd(' + rObj.project_list[i].p_no + ')">프로젝트 종료하기</button>'
                }

                infection_percentage = (rObj.project_list[i].infection / rObj.project_list[i].targets) * 100;

                if (full_tag === '') {
                  $('#project_list > tbody:last').append('<tr>' + '<td></td><td>' + rObj.project_list[i].fake_no
                          + '</td><td>' + rObj.project_list[i].p_name + '</td><td>' + full_tag + '</td>'
                          + '<td>' + status + '</td><td>' + rObj.project_list[i].tmp_no + '</td>'
                          + '<td>' + rObj.project_list[i].targets + ' 명</td>' // 전체 대상자수
                          + '<td><progress class="valign-middle" value=' + 'rObj.project_list[i].infection max='
                          + 'rObj.project_list[i].targets></progress>' + infection_percentage
                          + "%(" + rObj.project_list[i].infection +"명)"
                          + '</td><td>' + end + '</td>'
                          + '<td>' + rObj.project_list[i].start_date + '</td><td>' + rObj.project_list[i].end_date
                          + '</td></tr>');
                } else {
                $('#project_list > tbody:last').append('<tr>' + '<td></td><td>' + rObj.project_list[i].fake_no
                        + '</td><td>' + rObj.project_list[i].p_name + '</td><td>' + full_tag + '</td>'
                        + '<td>' + status + '</td><td>' + rObj.project_list[i].tmp_no + '</td>'
                        + '<td>' + rObj.project_list[i].targets + ' 명</td>' // 전체 대상자수
                        + '<td><progress class="valign-middle" value=' + 'rObj.project_list[i].infection max='
                        + 'rObj.project_list[i].targets></progress>' + infection_percentage
                        + "%(" + rObj.project_list[i].infection +"명)"
                        + '</td><td>' + end + '</td>'
                        + '<td>' + rObj.project_list[i].start_date + '</td><td>' + rObj.project_list[i].end_date
                        + '</td></tr>');

              }
            }
          } else if (rObj.project_list === null) {
            document.getElementById('under').style.background="#f2eff1";
            $('#project_list').append('<tr style="background-color:white"><td colspan="11" align="center">' +
                    '<div class="alert alert" style="background-color:white">' +
                    '<p align="center"><span style="border: 1px; font-size:15px;' +
                    'font-style: italic; font-weight: 100;">진행중인 프로젝트가 없습니다.</span></p>' +
                    '</div></td></tr>');
          }
        } else if (r.status === 403) {
          const tokenResult = Refresh();
          if (tokenResult) {
            GetProject();
          } else {
            document.location.href = '/';
          }
        }
      }
    };
    r.send();
  }

  //종료하기 버튼 누른경우 작동하는 기능
  function ProjectEnd(p_no) {
    const r = new XMLHttpRequest();
    const verify = confirm("해당 프로젝트를 종료하시겠습니까?");
    if (verify === true) {
      r.open('POST', 'http://localhost:5000/api/endProjectList', true);
      r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      r.withCredentials = true;
      r.onreadystatechange = function () {
        if (r.readyState === 4) {
          if (r.status === 200) {
            alert('해당 프로젝트가 종료되었습니다.');
            document.location.reload();
          } else if (r.status === 403) {
            const tokenResult = Refresh();
            if (tokenResult) {
              ProjectEnd(p_no);
            }
          } else {
            document.location.href = '/';
          }
        }
      };
    }
    else {
      alert("취소되었습니다.");
    }

    console.log(p_no);
    r.send(JSON.stringify({"p_no": p_no}));
  }

  function ProjectStart(p_no) {
    const r = new XMLHttpRequest();
    const verify = confirm("해당 프로젝트를 실행하시겠습니까?");
    if (verify === true) {
      r.open('POST', 'http://localhost:5000/api/startProjectList', true);
      r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      r.withCredentials = true;
      r.onreadystatechange = function () {
        if (r.readyState === 4) {
          if (r.status === 200) {
            alert('프로젝트가 시작되었습니다.');
            document.location.reload();
          } else if (r.status === 403) {
            const tokenResult = Refresh();
            if (tokenResult) {
              ProjectStart(p_no);
            }
          } else {
            document.location.href = '/';
          }
        }
      };
    }
    else {
      alert("취소되었습니다.");
    }

    console.log(p_no);
    r.send(JSON.stringify({"p_no": p_no}));
  }



  getTag();
  GetProject();
  </script>
</body>

</html>
